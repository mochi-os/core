#!/bin/bash
# Build a macOS .pkg installer from Linux
# Usage: build-pkg <binary> <version> <arch> <output.pkg>
# Requires: mkbom (bomutils), xar

set -e

BINARY="$1"
VERSION="$2"
ARCH="$3"
OUTPUT="$4"
SCRIPT_DIR="$(dirname "$0")"
BUILD_DIR="$(mktemp -d)"
ROOT_DIR="$BUILD_DIR/root"
SCRIPTS_DIR="$BUILD_DIR/scripts"
COMP_DIR="$BUILD_DIR/comp"
PRODUCT_DIR="$BUILD_DIR/product"
PKG_ID="org.mochi-os.server"

trap "rm -rf $BUILD_DIR" EXIT

# Create payload directory structure
mkdir -p "$ROOT_DIR/usr/local/bin"
mkdir -p "$ROOT_DIR/etc/mochi"
mkdir -p "$ROOT_DIR/Library/LaunchDaemons"
mkdir -p "$ROOT_DIR/var/cache/mochi"
mkdir -p "$ROOT_DIR/var/lib/mochi"

cp "$BINARY" "$ROOT_DIR/usr/local/bin/mochi-server"
chmod 755 "$ROOT_DIR/usr/local/bin/mochi-server"
cp "$SCRIPT_DIR/../pkg/mochi.conf" "$ROOT_DIR/etc/mochi/mochi.conf"
cp "$SCRIPT_DIR/../pkg/org.mochi-os.server.plist" "$ROOT_DIR/Library/LaunchDaemons/"

# Copy install scripts
cp -a "$SCRIPT_DIR/../pkg/scripts" "$SCRIPTS_DIR"

# Build the component package
mkdir -p "$COMP_DIR"

# Build BOM
ls4mkbom -u 0 -g 0 "$ROOT_DIR" > "$BUILD_DIR/bom.list"
mkbom -i "$BUILD_DIR/bom.list" "$COMP_DIR/Bom"

# Build Payload (gzipped cpio)
(cd "$ROOT_DIR" && find . | cpio -o --format newc 2>/dev/null | gzip -c) > "$COMP_DIR/Payload"

# Build Scripts archive (gzipped cpio of scripts directory)
(cd "$SCRIPTS_DIR" && find . | cpio -o --format newc 2>/dev/null | gzip -c) > "$COMP_DIR/Scripts"

# Calculate payload size in KB
PAYLOAD_SIZE=$(du -sk "$ROOT_DIR" | cut -f1)
NUM_FILES=$(find "$ROOT_DIR" -type f | wc -l)

# Create PackageInfo
cat > "$COMP_DIR/PackageInfo" << EOF
<?xml version="1.0" encoding="utf-8"?>
<pkg-info format-version="2" identifier="$PKG_ID" version="$VERSION" install-location="/" auth="root" overwrite-permissions="false">
    <payload installKBytes="$PAYLOAD_SIZE" numberOfFiles="$NUM_FILES"/>
    <scripts>
        <preinstall file="preinstall"/>
        <postinstall file="postinstall"/>
    </scripts>
</pkg-info>
EOF

# Build product archive (required for macOS GUI Installer)
mkdir -p "$PRODUCT_DIR/$PKG_ID.pkg"
cp "$COMP_DIR/Bom" "$COMP_DIR/Payload" "$COMP_DIR/Scripts" "$COMP_DIR/PackageInfo" "$PRODUCT_DIR/$PKG_ID.pkg/"

# Create Distribution file
cat > "$PRODUCT_DIR/Distribution" << EOF
<?xml version="1.0" encoding="utf-8"?>
<installer-gui-script minSpecVersion="2">
    <title>Mochi Server</title>
    <options customize="never" require-scripts="false"/>
    <choices-outline>
        <line choice="default">
            <line choice="$PKG_ID"/>
        </line>
    </choices-outline>
    <choice id="default"/>
    <choice id="$PKG_ID" visible="false">
        <pkg-ref id="$PKG_ID"/>
    </choice>
    <pkg-ref id="$PKG_ID" version="$VERSION" onConclusion="none">#$PKG_ID.pkg</pkg-ref>
</installer-gui-script>
EOF

# Build the .pkg using xar
(cd "$PRODUCT_DIR" && xar --compression none -cf "$OUTPUT" .)

echo "Built: $OUTPUT ($(du -h "$OUTPUT" | cut -f1))"
